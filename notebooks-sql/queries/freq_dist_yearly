-- Final and Correct
CREATE OR REPLACE VIEW wind_sites.frequency_distribution_yearly AS
WITH MaxWindSpeed AS(
	SELECT
		CEIL(MAX(wind_speed)) AS max_speed
	FROM
		wind_sites.upd_wind_site
),
BinnedSpeed AS (
	SELECT 
		EXTRACT(YEAR FROM date_time) AS year,
		wind_speed, 
		width_bucket(
			CAST(wind_speed AS double precision),
			0,
			CAST((SELECT max_speed FROM MaxWindSpeed) AS double precision), 
			CAST((SELECT max_speed FROM MaxWindSpeed) AS integer) 
		) AS speed_bin
	FROM 
		wind_sites.upd_wind_site
), 
YearlyCounts AS (
    SELECT
        year,
        speed_bin,
        COUNT(*) AS frequency,
        SUM(COUNT(*)) OVER (PARTITION BY year) AS yearly_total
    FROM
        BinnedSpeed
    GROUP BY 
        year,
        speed_bin 
)
-- Final Select
SELECT
    year,
    speed_bin,
    frequency,
    ROUND((frequency / yearly_total) * 100,3) as percent_frequency
FROM 
    YearlyCounts
ORDER BY
    year,
    speed_bin
;